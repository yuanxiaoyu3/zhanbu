<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="神秘占卜屋 - 专业的在线占卜平台">
    <meta name="keywords" content="占卜,算命,星座运势,六爻,易经">
    <title>神秘占卜屋 - 探索命运的奥秘</title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <style>
        body {
            background: linear-gradient(135deg, #1c1c3d, #2a1b3d);
            color: #e0e0e0;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background: linear-gradient(135deg, #7918d9, #3485fd);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        select {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        select option {
            background: #1c1c3d;
            color: white;
            padding: 12px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 15px rgba(106, 17, 203, 0.3);
        }
        .hexagram-display {
            margin: 30px auto;
            max-width: 300px;
            padding: 40px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hexagram-line-container {
            width: 200px;
            height: 40px;
            margin: 10px 0;
            position: relative;
        }
        .position-label {
            position: absolute;
            right: -60px;
            top: 50%;
            transform: translateY(-50%);
            color: #e0e0e0;
            font-size: 14px;
        }
        .result-layers {
            display: block;
            padding: 25px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }
        .post-form textarea {
            width: 100%;
            min-height: 100px;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            resize: vertical;
        }

        .post {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .post-content {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .post-meta {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }

        .post-time {
            font-style: italic;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
    </style>

    <script>
        // 定义 API 基础 URL
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3006' 
            : 'https://api.zhanbu.xin';

        // 八卦基础数据
        const bagua = {
            qian: { name: '乾', nature: '天', value: [1,1,1], symbol: '☰' },
            dui: { name: '兑', nature: '泽', value: [1,1,0], symbol: '☱' },
            li: { name: '离', nature: '火', value: [1,0,1], symbol: '☲' },
            zhen: { name: '震', nature: '雷', value: [0,0,1], symbol: '☳' },
            xun: { name: '巽', nature: '风', value: [1,1,0], symbol: '☴' },
            kan: { name: '坎', nature: '水', value: [0,1,0], symbol: '☵' },
            gen: { name: '艮', nature: '山', value: [1,0,0], symbol: '☶' },
            kun: { name: '坤', nature: '地', value: [0,0,0], symbol: '☷' }
        };

        // SVG 版本的显示卦象函数
        function displayHexagram(lines) {
            const display = document.getElementById('hexagramDisplay');
            if (!display) return;
            display.innerHTML = '';
            
            // 从下往上显示爻
            for(let i = lines.length - 1; i >= 0; i--) {
                const container = document.createElement('div');
                container.className = 'hexagram-line-container';
                
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute("width", "200");
                svg.setAttribute("height", "40");
                
                const gradientId = `gradient-${i}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                // 添加渐变定义
                const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                const gradient = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
                gradient.setAttribute("id", gradientId);
                gradient.innerHTML = `
                    <stop offset="0%" stop-color="#6a11cb"/>
                    <stop offset="100%" stop-color="#2575fc"/>
                `;
                defs.appendChild(gradient);
                svg.appendChild(defs);
                
                if(lines[i] === 1) {
                    // 阳爻
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    line.setAttribute("x", "0");
                    line.setAttribute("y", "14");
                    line.setAttribute("width", "200");
                    line.setAttribute("height", "12");
                    line.setAttribute("fill", `url(#${gradientId})`);
                    line.setAttribute("rx", "6");
                    svg.appendChild(line);
                } else {
                    // 阴爻
                    const leftLine = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    leftLine.setAttribute("x", "0");
                    leftLine.setAttribute("y", "14");
                    leftLine.setAttribute("width", "85");
                    leftLine.setAttribute("height", "12");
                    leftLine.setAttribute("fill", `url(#${gradientId})`);
                    leftLine.setAttribute("rx", "6");
                    
                    const rightLine = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rightLine.setAttribute("x", "115");
                    rightLine.setAttribute("y", "14");
                    rightLine.setAttribute("width", "85");
                    rightLine.setAttribute("height", "12");
                    rightLine.setAttribute("fill", `url(#${gradientId})`);
                    rightLine.setAttribute("rx", "6");
                    
                    svg.appendChild(leftLine);
                    svg.appendChild(rightLine);
                }
                
                container.appendChild(svg);

                const label = document.createElement('div');
                label.className = 'position-label';
                label.textContent = ['上爻', '五爻', '四爻', '三爻', '二爻', '初爻'][i];
                container.appendChild(label);

                display.appendChild(container);
            }
        }


        // 计算变爻
        function calculateChangingLines(coins) {
            const sum = coins.reduce((a, b) => a + b, 0);
            const value = sum % 2; // 0为阴，1为阳
            const changing = sum === 6 || sum === 9; // 6和9为变爻
            
            // 添加动态变化强度
            const strength = Math.abs(sum - 7.5) / 1.5; // 变化强度 0-1
            
            return { value, changing, strength };
        }

        // 显示结果的增强版本
        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            if (!data) {
                resultDiv.innerHTML = '<div class="result-layers"><div class="basic-layer"><p>无法获取解卦结果</p></div></div>';
                return;
            }

            // 添加时间影响因素
            const hour = new Date().getHours();
            const timeInfluence = 
                hour >= 23 || hour < 1 ? '子时' : 
                hour >= 1 && hour < 3 ? '丑时' : 
                hour >= 3 && hour < 5 ? '寅时' :
                hour >= 5 && hour < 7 ? '卯时' :
                hour >= 7 && hour < 9 ? '辰时' :
                hour >= 9 && hour < 11 ? '巳时' :
                hour >= 11 && hour < 13 ? '午时' :
                hour >= 13 && hour < 15 ? '未时' :
                hour >= 15 && hour < 17 ? '申时' :
                hour >= 17 && hour < 19 ? '酉时' :
                hour >= 19 && hour < 21 ? '戌时' : '亥时';
            resultDiv.innerHTML = `
                <div class="result-layers">
                    <div class="basic-layer">
                        <h3>基础解读</h3>
                        <p>${data.basicInterpretation || '暂无基础解读'}</p>
                    </div>
                    <div class="interpretation-layer">
                        <h3>详细分析</h3>
                        <p>${data.detailedInterpretation || '暂无详细分析'}</p>
                    </div>
                    <div class="time-influence">
                        <h3>时间影响</h3>
                        <p>当前时辰：${timeInfluence}</p>
                    </div>
                </div>
            `;
        }

        // 每日运势功能
        // 修改每日运势请求
        async function getDailyFortune() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/divination/daily`);
                const data = await response.json();
                const fortuneDiv = document.getElementById('dailyFortune');
                fortuneDiv.innerHTML = `
                    <div class="result-layers" style="display: block;">
                        <div class="basic-layer">
                            <p>${data.fortune}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error:', error);
                alert('获取运势失败，请稍后重试');
            }
        }

        // 时间起卦
        async function castByTime() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const second = now.getSeconds();
            
            const lines = [];
            lines.push((hour % 6) % 2);   // 初爻
            lines.push((minute % 30) % 2); // 二爻
            lines.push((second % 30) % 2); // 三爻
            lines.push((hour % 12) % 2);   // 四爻
            lines.push((minute % 60) % 2); // 五爻
            lines.push((second % 60) % 2); // 上爻

            displayHexagram(lines);
            try {
                const response = await fetch(`${API_BASE_URL}/api/divination/liuyao/full`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lines,
                        changes: [],
                        question: document.getElementById('question').value,
                        type: document.getElementById('questionType').value
                    }),
                });
                
                const data = await response.json();
                displayResult(data);
            } catch (error) {
                console.error('Error:', error);
                displayResult({
                    basicInterpretation: "连接服务器失败",
                    detailedInterpretation: "请检查后端服务是否正常运行"
                });
            }
        }

        // 铜钱起卦
        async function castByCoins() {
            const lines = [];
            const changes = [];
            
            // 使用更精确的随机数生成
            const getRandomInt = (min, max) => {
                const range = max - min + 1;
                const bytes = new Uint8Array(1);
                window.crypto.getRandomValues(bytes);
                return min + (bytes[0] % range);
            };

            // 模拟真实的铜钱概率
            const throwCoins = () => {
                const coins = Array(3).fill(0).map(() => {
                    // 模拟铜钱的物理特性，正面概率略高
                    return Math.random() < 0.51 ? 3 : 2;
                });
                return coins;
            };

            for(let i = 0; i < 6; i++) {
                const coins = throwCoins();
                const result = calculateChangingLines(coins);
                lines.push(result.value);
                changes.push(result.changing);
                
                // 添加时间因素
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            displayHexagram(lines);
            try {
                const response = await fetch(`${API_BASE_URL}/api/divination/liuyao/full`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lines,
                        changes,
                        question: document.getElementById('question').value,
                        type: document.getElementById('questionType').value
                    }),
                });
                
                const data = await response.json();
                displayResult(data);
            } catch (error) {
                console.error('Error:', error);
                alert('起卦失败，请稍后重试');
            }
        }

        // 数字起卦
        async function castByNumber() {
            const number = prompt('请输入1-100之间的数字：');
            if(!number || isNaN(number) || number < 1 || number > 100) {
                alert('请输入有效的数字');
                return;
            }

            const lines = [];
            let n = parseInt(number);
            
            // 使用更复杂的数字转化算法
            const generateLine = (num, position) => {
                const base = (num * position) % 100;
                const modifier = new Date().getMinutes() % 2;
                return ((base + modifier) % 2);
            };

            for(let i = 0; i < 6; i++) {
                lines.push(generateLine(n, i + 1));
            }

            displayHexagram(lines);
            try {
                const response = await fetch(`${API_BASE_URL}/api/divination/liuyao/full`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lines,
                        changes: [],
                        question: document.getElementById('question').value,
                        type: document.getElementById('questionType').value
                    }),
                });
                
                const data = await response.json();
                displayResult(data);
            } catch (error) {
                console.error('Error:', error);
                alert('起卦失败，请稍后重试');
            }
        }

        // 获取星座运势
        async function getZodiacReading() {
            const sign = document.getElementById('zodiacSign').value;
            if (!sign) {
                alert('请选择星座');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/zodiac/${sign}`);
                const data = await response.json();
                const zodiacDiv = document.getElementById('zodiacResult');
                zodiacDiv.innerHTML = `
                    <div class="result-layers">
                        <div class="basic-layer">
                            <h3>今日运势</h3>
                            <p>${data.daily || '暂无数据'}</p>
                        </div>
                        <div class="interpretation-layer">
                            <h3>星座特点</h3>
                            <p>${data.characteristics || '暂无数据'}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error:', error);
                alert('获取星座运势失败，请稍后重试');
            }
        }

        // 发布帖子
        async function submitPost() {
            const content = document.getElementById('postContent').value;
            if (!content.trim()) {
                alert('请输入内容');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/community/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content }),
                });
                
                if (response.ok) {
                    document.getElementById('postContent').value = '';
                    loadPosts();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('发布失败，请稍后重试');
            }
        }

        // 加载帖子列表
        async function loadPosts() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/community/posts`);
                const posts = await response.json();
                const postsDiv = document.getElementById('postsList');
                postsDiv.innerHTML = posts.map(post => `
                    <div class="post">
                        <div class="post-content">${post.content}</div>
                        <div class="post-meta">
                            <span class="post-time">${new Date(post.timestamp).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // 页面切换功能
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示选中的页面
            document.getElementById(pageId).classList.add('active');
            
            // 更新导航栏高亮
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if(item.getAttribute('href') === '#' + pageId) {
                    item.classList.add('active');
                }
            });
        }

        // 页面加载时根据 URL hash 显示对应页面
        window.onload = function() {
            const hash = window.location.hash.slice(1) || 'daily';
            showPage(hash);
            loadPosts(); // 保持原有的帖子加载功能
        }

        // 监听 URL hash 变化
        window.onhashchange = function() {
            const hash = window.location.hash.slice(1);
            showPage(hash);
        }
    </script>
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="#daily" class="nav-item" onclick="showPage('daily')">每日运势</a>
            <a href="#liuyao" class="nav-item" onclick="showPage('liuyao')">六爻占卜</a>
            <a href="#zodiac" class="nav-item" onclick="showPage('zodiac')">星座解析</a>
            <a href="#community" class="nav-item" onclick="showPage('community')">占卜社区</a>
        </nav>

        <div id="daily" class="page">
            <div class="card">
                <h1>每日运势 <span class="tooltip">ℹ️<span class="tooltip-text">基于心理学投射原理的个性化解读</span></span></h1>
                <button onclick="getDailyFortune()">查看今日运势</button>
                <div id="dailyFortune"></div>
            </div>
        </div>

        <div id="liuyao" class="page">
            <div class="card">
                <h1>六爻占卜</h1>
                <select id="questionType">
                    <option value="general">综合运势</option>
                    <option value="career">事业学业</option>
                    <option value="love">感情婚姻</option>
                    <option value="health">健康平安</option>
                </select>
                <input type="text" id="question" placeholder="请输入你的问题...">
                <div class="button-group">
                    <button onclick="castByTime()">时间起卦</button>
                    <button onclick="castByCoins()">铜钱起卦</button>
                    <button onclick="castByNumber()">数字起卦</button>
                </div>
                <div id="hexagramDisplay" class="hexagram-display"></div>
                <div id="result"></div>
            </div>
        </div>

        <div id="zodiac" class="page">
            <div class="card">
                <h1>星座解析</h1>
                <select id="zodiacSign">
                    <option value="">选择星座...</option>
                    <option value="aries">白羊座 (3.21-4.19)</option>
                    <option value="taurus">金牛座 (4.20-5.20)</option>
                    <option value="gemini">双子座 (5.21-6.21)</option>
                    <option value="cancer">巨蟹座 (6.22-7.22)</option>
                    <option value="leo">狮子座 (7.23-8.22)</option>
                    <option value="virgo">处女座 (8.23-9.22)</option>
                    <option value="libra">天秤座 (9.23-10.23)</option>
                    <option value="scorpio">天蝎座 (10.24-11.22)</option>
                    <option value="sagittarius">射手座 (11.23-12.21)</option>
                    <option value="capricorn">摩羯座 (12.22-1.19)</option>
                    <option value="aquarius">水瓶座 (1.20-2.18)</option>
                    <option value="pisces">双鱼座 (2.19-3.20)</option>
                </select>
                <button onclick="getZodiacReading()">获取星座运势</button>
                <div id="zodiacResult"></div>
            </div>
        </div>

        <div id="community" class="page">
            <div class="card">
                <h1>占卜社区</h1>
                <div class="post-form">
                    <textarea id="postContent" placeholder="分享你的占卜经验和感悟..."></textarea>
                    <button onclick="submitPost()">发布</button>
                </div>
                <div id="postsList"></div>
            </div>
        </div>
    </div>


